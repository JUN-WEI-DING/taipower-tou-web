# 電費單資料完整性 - 完整情境分析與解決方案

## 所有可能的使用情境

### 電費單型別 × 比較方案矩陣

| 當前方案 | 電費單有什麼資料 | 想比較的方案 | 需要什麼資料 | 是否缺少 | 解決方式 |
|----------|------------------|--------------|--------------|----------|----------|
| **非時間電價** | 總用電度數 | 兩段式時間電價 | 尖峰 + 離峰 | ❌ 缺少 | 用電習慣估算 |
| **非時間電價** | 總用電度數 | 三段式時間電價 | 尖峰 + 半尖峰 + 離峰 | ❌ 缺少 | 用電習慣估算 |
| **兩段式時間電價** | 尖峰 + 離峰度數 | 非時間電價 | 總用電度數 | ✅ 有 | 直接計算 |
| **兩段式時間電價** | 尖峰 + 離峰度數 | 三段式時間電價 | 尖峰 + 半尖峰 + 離峰 | ⚠️ 部分缺少 | 從尖峰拆分 |
| **三段式時間電價** | 尖峰 + 半尖峰 + 離峰 | 任何方案 | 完整資料 | ✅ 有 | 直接計算 |

### 其他限制因素

| 限制型別 | 說明 | 影響 |
|----------|------|------|
| **電壓型別** | 低壓(110V/220V) vs 高壓(3300V以上) | 不能跨電壓比較 |
| **相別** | 單相 vs 三相 | 基本電費不同 |
| **契約容量** | 某些方案有最低要求 | 需檢查是否符合資格 |
| **特殊電錶** | 某些方案需特殊電錶 | 需標示需申請 |

---

## 完整解決方案架構

### 核心概念：資料完整度等級

```typescript
// types/data-completeness.d.ts

/**
 * 資料完整度等級
 */
enum DataCompletenessLevel {
  /**
   * 等級 1：只有總用電度數
   * - 來源：非時間電價電費單
   * - 可計算：非時間電價方案
   * - 需估算：時間電價方案（需時段分配）
   */
  TOTAL_ONLY = 'total_only',

  /**
   * 等級 2：兩段式時間電價資料
   * - 來源：兩段式時間電價電費單
   * - 可計算：非時間電價、兩段式時間電價
   * - 需估算：三段式時間電價（需從尖峰拆分半尖峰）
   */
  TWO_TIER = 'two_tier',

  /**
   * 等級 3：三段式時間電價資料
   * - 來源：三段式時間電價電費單
   * - 可計算：所有方案
   * - 需估算：無
   */
  THREE_TIER = 'three_tier',
}

/**
 * 電費單資料結構（統一格式）
 */
interface BillData {
  // 基本資訊
  customerName?: string;
  accountNumber?: string;
  billingPeriod: {
    start: Date;
    end: Date;
  };

  // 用電資訊
  consumption: {
    total: number;           // 總用電（必填）
    peakOnPeak?: number;     // 尖峰用電（兩段式/三段式）
    semiPeak?: number;       // 半尖峰用電（僅三段式）
    offPeak?: number;        // 離峰用電（兩段式/三段式）
  };

  // 當前方案資訊
  currentPlan?: {
    id: string;
    name: string;
    type: 'non_tou' | 'two_tier' | 'three_tier';
    totalCharge: number;
  };

  // 契約資訊（從電費單或預設值）
  contract?: {
    voltageType: 'low_voltage' | 'high_voltage';
    phase: 'single' | 'three';
    capacity?: number;       // 契約容量（高壓使用者）
  };

  // 資料來源
  source: {
    type: 'ocr' | 'manual';
    completenessLevel: DataCompletenessLevel;
    isEstimated: boolean;
    estimationMode?: EstimationMode;
  };
}

/**
 * 估算模式定義
 */
enum EstimationMode {
  /** 平均用電模式（一般上班族家庭） */
  AVERAGE = 'average',

  /** 白天在家的家庭 */
  HOME_DURING_DAY = 'home_during_day',

  /** 夜貓子型 */
  NIGHT_OWL = 'night_owl',

  /** 自訂比例 */
  CUSTOM = 'custom',

  /** 從兩段式拆分（特殊模式） */
  SPLIT_FROM_TWO_TIER = 'split_from_two_tier',
}
```

---

## 場景 1：非時間電價電費單（最常見）

### 電費單樣貌

```
┌─────────────────────────────────────┐
│ 臺灣電力公司 電費通知單             │
├─────────────────────────────────────┤
│ 計費期間：114年01月 ~ 114年01月     │
│ 本期用電：350 度                    │
│ 電費小計：$2,345                    │
└─────────────────────────────────────┘
```

### 可提取的資料

```typescript
{
  consumption: {
    total: 350,
    // peakOnPeak: undefined,  ❌ 沒有
    // semiPeak: undefined,     ❌ 沒有
    // offPeak: undefined,      ❌ 沒有
  },
  currentPlan: {
    type: 'non_tou',
  },
  source: {
    completenessLevel: DataCompletenessLevel.TOTAL_ONLY,
  },
}
```

### 比較結果

| 想比較的方案 | 資料足夠嗎 | 顯示標示 |
|--------------|-----------|----------|
| 非時間電價 | ✅ 有總用電 | ✅ 準確 |
| 兩段式時間電價 | ❌ 缺少時段 | ⚠️ 需估算 |
| 三段式時間電價 | ❌ 缺少時段 | ⚠️ 需估算 |

### UI 顯示

```
選擇最像你家的用電習慣，幫你估算時間電價

┌─────────────────┐  ┌─────────────────┐
│ 👨‍💼👩‍💼 一般上班族 │  │ 👵👶 白天在家   │
└─────────────────┘  └─────────────────┘
┌─────────────────┐  ┌─────────────────┐
│ 🦉 夜貓子型     │  │ 🎚️ 我自己調整   │
└─────────────────┘  └─────────────────┘

結果顯示：
🥇 三段式時間電價    $2,100  ⚠️估算
🥈 兩段式時間電價    $2,180  ⚠️估算
 3  住家用電(非時間)  $2,345  ✅準確  ← 當前方案
```

---

## 場景 2：兩段式時間電價電費單

### 電費單樣貌

```
┌─────────────────────────────────────┐
│ 臺灣電力公司 電費通知單             │
│ 簡易型時間電價-二段式               │
├─────────────────────────────────────┤
│ 計費期間：114年01月 ~ 114年01月     │
│                                     │
│ 尖峰用電：120 度                    │
│ 離峰用電：230 度                    │
│ ────────────────────────────        │
│ 總用電：350 度                      │
│ 電費小計：$2,180                    │
└─────────────────────────────────────┘
```

### 可提取的資料

```typescript
{
  consumption: {
    total: 350,
    peakOnPeak: 120,    // ✅ 有
    // semiPeak: undefined,  ❌ 兩段式沒有半尖峰
    offPeak: 230,       // ✅ 有
  },
  currentPlan: {
    type: 'two_tier',
  },
  source: {
    completenessLevel: DataCompletenessLevel.TWO_TIER,
  },
}
```

### 比較結果

| 想比較的方案 | 資料足夠嗎 | 顯示標示 | 說明 |
|--------------|-----------|----------|------|
| 非時間電價 | ✅ 有總用電 | ✅ 準確 | 直接計算 |
| 兩段式時間電價 | ✅ 有完整資料 | ✅ 準確 | 直接計算 |
| 三段式時間電價 | ⚠️ 需拆分 | ⚠️ 部分估算 | 需從尖峰拆分半尖峰 |

### 三段式如何處理？

**問題**：三段式時間電價需要「尖峰 + 半尖峰 + 離峰」，但兩段式只有「尖峰 + 離峰」

**解決方案**：將兩段式的尖峰按比例拆分為三段式的尖峰和半尖峰

```
兩段式時段定義：
  尖峰：09:00 - 24:00 (15小時)
  離峰：00:00 - 09:00 (9小時)

三段式時段定義：
  尖峰：     10:00 - 12:00 (2小時) + 16:00 - 21:00 (5小時) = 7小時
  半尖峰：  07:00 - 10:00 (3小時) + 12:00 - 16:00 (4小時)
            + 21:00 - 23:00 (2小時) = 9小時
  離峰：    23:00 - 07:00 (8小時)

兩段式尖峰(15小時) = 三段式尖峰(7小時) + 三段式半尖峰(部分)

拆分策略：
  假設兩段式的尖峰用電，在三段式中：
  - 尖峰部分：7/15 = 46.7%
  - 半尖峰部分：9/15 = 53.3%（半尖峰在尖峰時段的）

實際計算：
  兩段式尖峰 120 度 → 三段式尖峰 56 度 + 三段式半尖峰 64 度
  再加上三段式半尖峰的其他時段用電（從離峰估算）
```

### UI 顯示

```
你的電費單有完整的兩段式資料

非時間電價        $2,345  ✅準確
兩段式時間電價    $2,180  ✅準確  ← 當前方案
三段式時間電價    $2,150  ⚠️部分估算  ← 需拆分半尖峰

💡 三段式時間電價需要半尖峰資料，
   我們幫你從兩段式的尖峰按比例拆分估算
```

---

## 場景 3：三段式時間電價電費單（最完整）

### 電費單樣貌

```
┌─────────────────────────────────────┐
│ 臺灣電力公司 電費通知單             │
│ 簡易型時間電價-三段式               │
├─────────────────────────────────────┤
│ 計費期間：114年01月 ~ 114年01月     │
│                                     │
│ 尖峰用電：70 度                     │
│ 半尖峰用電：80 度                   │
│ 離峰用電：200 度                    │
│ ────────────────────────────        │
│ 總用電：350 度                      │
│ 電費小計：$2,100                    │
└─────────────────────────────────────┘
```

### 可提取的資料

```typescript
{
  consumption: {
    total: 350,
    peakOnPeak: 70,     // ✅ 有
    semiPeak: 80,       // ✅ 有
    offPeak: 200,       // ✅ 有
  },
  currentPlan: {
    type: 'three_tier',
  },
  source: {
    completenessLevel: DataCompletenessLevel.THREE_TIER,
  },
}
```

### 比較結果

| 想比較的方案 | 資料足夠嗎 | 顯示標示 |
|--------------|-----------|----------|
| 非時間電價 | ✅ 有總用電 | ✅ 準確 |
| 兩段式時間電價 | ✅ 可合併計算 | ✅ 準確 |
| 三段式時間電價 | ✅ 有完整資料 | ✅ 準確 |

### 兩段式如何計算？

將三段式的半尖峰併入尖峰或離峰（依時段定義）

```
三段式 → 兩段式合併：
  三段式尖峰(70) + 三段式半尖峰部分 → 兩段式尖峰
  三段式半尖峰其餘 + 三段式離峰(200) → 兩段式離峰
```

### UI 顯示

```
你的電費單有完整的用電資料，所有方案都是準確計算！

非時間電價        $2,345  ✅準確
兩段式時間電價    $2,180  ✅準確
三段式時間電價    $2,100  ✅準確  ← 當前方案

所有結果都是依據電費單上的實際用電資料計算
```

---

## 場景 4：特殊限制

### 限制 1：電壓型別不同

```
低壓使用者電費單 (110V/220V)
    ↓
想比較高壓方案 (需3300V以上)

結果：
  ❌ 顯示「此方案需高壓用電，不適用於您」
  💡 建議：如需使用此方案，請向臺電申請改壓
```

### 限制 2：契約容量不足

```
某方案最低契約容量：10 kW
您的契約容量：5 kW

結果：
  ❌ 顯示「此方案需契約容量 10 kW 以上」
  💡 建議：請向臺電申請提高契約容量
```

### 限制 3：需特殊電錶

```
時間電價方案需時間電錶

結果：
  ⚠️ 顯示「此方案需裝設時間電價電錶」
  💡 說明：可向臺電申請免費安裝
```

---

## 完整判斷流程圖

```
                    電費單上傳
                        │
                        ▼
              ┌─────────────────┐
              │   OCR 識別      │
              └────────┬────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │  判斷資料完整度等級          │
        └──────────────┬───────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
   ┌─────────┐   ┌─────────┐   ┌─────────┐
   │只有總用電│   │兩段式   │   │三段式   │
   │非時間電價│   │時間電價 │   │時間電價 │
   └────┬────┘   └────┬────┘   └────┬────┘
        │              │              │
        ▼              ▼              ▼
 ┌──────────┐   ┌──────────┐   ┌──────────┐
 │選擇用電  │   │可計算    │   │可計算    │
 │習慣估算  │   │非時間    │   │所有方案  │
 │          │   │兩段式    │   │          │
 └─────┬────┘   │三段式需  │   └─────┬────┘
       │        │拆分估算  │         │
       ▼        └─────┬────┘         ▼
 ┌──────────┐         │        ┌──────────┐
 │顯示所有  │         ▼        │顯示所有  │
 │方案結果  │   ┌──────────┐   │方案結果  │
 │標示估算  │   │顯示所有  │   │全部準確  │
 │         │   │方案結果  │   │         │
 └──────────┘   │部分標示  │   └──────────┘
                │拆分估算  │
                └──────────┘
```

---

## 統一的結果顯示邏輯

```typescript
// services/calculation/ResultLabeler.ts

class ResultLabeler {
  /**
   * 為計算結果加上適當的標籤
   */
  static labelResult(
    result: PlanCalculationResult,
    inputData: BillData,
    targetPlan: Plan
  ): ResultWithLabel {
    const label: ResultLabel = {
      accuracy: 'accurate',
      badge: '✅ 準確',
      tooltip: '依據電費單資料計算',
    };

    // 判斷資料是否足夠
    const isDataSufficient = this.checkDataSufficiency(
      inputData,
      targetPlan
    );

    if (!isDataSufficient) {
      // 判斷估算型別
      if (inputData.source.completenessLevel === DataCompletenessLevel.TOTAL_ONLY) {
        label.accuracy = 'estimated';
        label.badge = '⚠️ 估算';
        label.tooltip = `依「${getHabitLabel(inputData.source.estimationMode)}」估算`;
      } else if (
        inputData.source.completenessLevel === DataCompletenessLevel.TWO_TIER &&
        targetPlan.touType === 'three_tier'
      ) {
        label.accuracy = 'partial_estimated';
        label.badge = '⚠️ 部分估算';
        label.tooltip = '從兩段式尖峰按比例拆分半尖峰';
      }
    }

    return { ...result, label };
  }

  /**
   * 檢查資料是否足夠計算目標方案
   */
  private static checkDataSufficiency(
    inputData: BillData,
    targetPlan: Plan
  ): boolean {
    // 非時間電價：只要有總用電就夠
    if (targetPlan.touType === 'none') {
      return true;
    }

    // 兩段式時間電價：需要尖峰和離峰
    if (targetPlan.touType === 'simple_2_tier') {
      return (
        inputData.consumption.peakOnPeak !== undefined &&
        inputData.consumption.offPeak !== undefined
      );
    }

    // 三段式時間電價：需要尖峰、半尖峰、離峰
    if (targetPlan.touType === 'simple_3_tier' || targetPlan.touType === 'full_tou') {
      return (
        inputData.consumption.peakOnPeak !== undefined &&
        inputData.consumption.semiPeak !== undefined &&
        inputData.consumption.offPeak !== undefined
      );
    }

    return false;
  }
}
```

---

## 更新後的完整 UI 流程

```
┌─────────────────────────────────────────────────────────────┐
│  電費單上傳 → OCR 識別                                      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  分析你的電費單...                                          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  ✅ 識別成功！本月用電 350 度                           │ │
│  │                                                         │ │
│  │  當前方案：簡易型時間電價-二段式                         │ │
│  │  ├─ 尖峰用電：120 度                                    │ │
│  │  └─ 離峰用電：230 度                                    │ │
│  │                                                         │ │
│  │  資料完整度：兩段式完整資料                              │ │
│  │  ✅ 非時間電價：可準確計算                              │ │
│  │  ✅ 兩段式時間電價：可準確計算                          │ │
│  │  ⚠️ 三段式時間電價：需估算（從尖峰拆分半尖峰）          │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  選擇處理方式                                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  對於三段式時間電價，我們需要拆分半尖峰：               │ │
│  │                                                         │ │
│  │  兩段式尖峰時段 = 三段式尖峰 + 三段式半尖峰(部分)      │ │
│  │                                                         │ │
│  │  [使用預設拆分比例]                                     │ │
│  │     尖峰 → 46.7% 尖峰 + 53.3% 半尖峰                    │ │
│  │                                                         │ │
│  │  [我來調整比例]                                         │ │
│  │     自訂拆分比例                                        │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  檢視比較結果                                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  🥇 三段式時間電價    $2,150  ⚠️部分估算                │ │
│  │  🥈 兩段式時間電價    $2,180  ✅準確  ← 當前方案        │ │
│  │  3  住家用電(非時間)  $2,345  ✅準確                    │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  💡 三段式時間電價可省 $30（從尖峰拆分半尖峰估算）          │
└─────────────────────────────────────────────────────────────┘
```

---

## 總結：所有情境對應

| 當前方案 | 資料完整度 | 非時間電價 | 兩段式 | 三段式 |
|----------|-----------|-----------|--------|--------|
| 非時間電價 | 只有總用電 | ✅ 準確 | ⚠️ 需估算 | ⚠️ 需估算 |
| 兩段式時間電價 | 尖峰+離峰 | ✅ 準確 | ✅ 準確 | ⚠️ 需拆分 |
| 三段式時間電價 | 完整 | ✅ 準確 | ✅ 準確 | ✅ 準確 |

**標示說明**：
- ✅ 準確：完全依據電費單資料計算
- ⚠️ 需估算：需選擇用電習慣來估算時段分配
- ⚠️ 需拆分：需從現有時段按比例拆分
